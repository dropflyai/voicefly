-- Check auth settings and create service role function for signup

-- First, let's create a function that uses service role to bypass RLS during signup
CREATE OR REPLACE FUNCTION create_business_for_new_user(
  p_business_name TEXT,
  p_email TEXT,
  p_phone TEXT,
  p_business_type TEXT,
  p_user_id UUID,
  p_first_name TEXT,
  p_last_name TEXT
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER -- This runs with the permissions of the function owner (bypasses RLS)
AS $$
DECLARE
  v_business_id UUID;
  v_result JSON;
BEGIN
  -- Insert business
  INSERT INTO businesses (
    name,
    slug,
    business_type,
    email,
    phone,
    subscription_tier,
    subscription_status,
    trial_ends_at,
    timezone,
    created_at,
    updated_at
  ) VALUES (
    p_business_name,
    lower(regexp_replace(p_business_name, '[^a-z0-9]+', '-', 'g')),
    p_business_type,
    p_email,
    COALESCE(p_phone, ''),
    'professional',
    'trial',
    NOW() + INTERVAL '14 days',
    'America/Los_Angeles',
    NOW(),
    NOW()
  )
  RETURNING id INTO v_business_id;

  -- Insert business_user association
  INSERT INTO business_users (
    user_id,
    business_id,
    role,
    first_name,
    last_name,
    phone,
    created_at,
    updated_at
  ) VALUES (
    p_user_id,
    v_business_id,
    'owner',
    p_first_name,
    p_last_name,
    p_phone,
    NOW(),
    NOW()
  );

  -- Return the business data
  SELECT json_build_object(
    'id', id,
    'name', name,
    'email', email,
    'business_type', business_type
  ) INTO v_result
  FROM businesses
  WHERE id = v_business_id;

  RETURN v_result;
END;
$$;

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION create_business_for_new_user TO authenticated;

-- Verify function was created
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_name = 'create_business_for_new_user';
